// @tensorflow/tfjs-models Copyright 2019 Google
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@tensorflow/tfjs")):"function"==typeof define&&define.amd?define(["exports","@tensorflow/tfjs"],t):t(e.posenet={},e.tf)}(this,function(e,t){"use strict";function n(e,t,n,r){return new(n||(n=Promise))(function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(s,a)}u((r=r.apply(e,t||[])).next())})}function r(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var i=function(){function e(e){this.urlPath=e,"/"!==this.urlPath.charAt(this.urlPath.length-1)&&(this.urlPath+="/")}return e.prototype.loadManifest=function(){var e=this;return new Promise(function(i,o){return n(e,void 0,void 0,function(){var e,n,o;return r(this,function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),[4,t.util.fetch(this.urlPath+"manifest.json")];case 1:if(!(e=r.sent()).ok)throw new Error("Not found manifest "+this.urlPath+"manifest.json");return n=this,[4,e.json()];case 2:return n.checkpointManifest=r.sent(),i(),[3,4];case 3:throw o=r.sent(),new Error("manifest.json not found at "+this.urlPath+". "+o);case 4:return[2]}})})})},e.prototype.getCheckpointManifest=function(){var e=this;return null==this.checkpointManifest?new Promise(function(t,n){e.loadManifest().then(function(){t(e.checkpointManifest)})}):new Promise(function(t,n){t(e.checkpointManifest)})},e.prototype.getAllVariables=function(){var e=this;return null!=this.variables?new Promise(function(t,n){t(e.variables)}):new Promise(function(t,n){e.getCheckpointManifest().then(function(n){for(var r=Object.keys(e.checkpointManifest),i=[],o=0;o<r.length;o++)i.push(e.getVariable(r[o]));Promise.all(i).then(function(n){e.variables={};for(var i=0;i<n.length;i++)e.variables[r[i]]=n[i];t(e.variables)})})})},e.prototype.getVariable=function(e){var i=this;if(!(e in this.checkpointManifest))throw new Error("Cannot load non-existant variable "+e);var o=function(o,s){return n(i,void 0,void 0,function(){var n,i,s,a,u,l;return r(this,function(r){switch(r.label){case 0:n=this.checkpointManifest[e].filename,r.label=1;case 1:return r.trys.push([1,4,,5]),[4,t.util.fetch(this.urlPath+n)];case 2:if(!(i=r.sent()).ok)throw new Error("Not found variable "+e);return a=Float32Array.bind,[4,i.arrayBuffer()];case 3:return s=new(a.apply(Float32Array,[void 0,r.sent()])),u=t.tensor(s,this.checkpointManifest[e].shape,"float32"),o(u),[3,5];case 4:throw l=r.sent(),new Error("Could not fetch variable "+e+": "+l);case 5:return[2]}})})};return null==this.checkpointManifest?new Promise(function(e,t){i.loadManifest().then(function(){new Promise(o).then(e)})}):new Promise(o)},e}(),o=[["conv2d",2],["separableConv",1],["separableConv",2],["separableConv",1],["separableConv",2],["separableConv",1],["separableConv",2],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1]],s=[8,16,32];function a(e){t.util.assert("number"==typeof e,function(){return"outputStride is not a number"}),t.util.assert(s.indexOf(e)>=0,function(){return"outputStride of "+e+" is invalid. It must be either 8, 16, or 32"})}function u(e){t.util.assert("number"==typeof e,function(){return"imageScaleFactor is not a number"}),t.util.assert(e>=.2&&e<=1,function(){return"imageScaleFactor must be between 0.2 and 1.0"})}var l={100:[["conv2d",2],["separableConv",1],["separableConv",2],["separableConv",1],["separableConv",2],["separableConv",1],["separableConv",2],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",2],["separableConv",1]],75:[["conv2d",2],["separableConv",1],["separableConv",2],["separableConv",1],["separableConv",2],["separableConv",1],["separableConv",2],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1],["separableConv",1]],50:o,25:o};var c=function(){function e(e,n){this.PREPROCESS_DIVISOR=t.scalar(127.5),this.ONE=t.scalar(1),this.modelWeights=e,this.convolutionDefinitions=n}return e.prototype.predict=function(e,n){var r=this,i=t.div(e.toFloat(),this.PREPROCESS_DIVISOR),o=t.sub(i,this.ONE);return function(e,t){var n=1,r=1;return e.map(function(e,i){var o,s,a=e[0],u=e[1];return n===t?(o=1,s=r,r*=u):(o=u,s=1,n*=u),{blockId:i,convType:a,stride:o,rate:s,outputStride:n}})}(this.convolutionDefinitions,n).reduce(function(e,t){var n=t.blockId,i=t.stride,o=t.convType,s=t.rate;if("conv2d"===o)return r.conv(e,i,n);if("separableConv"===o)return r.separableConv(e,i,n,s);throw Error("Unknown conv type of "+o)},o)},e.prototype.convToOutput=function(e,t){return e.conv2d(this.weights(t),1,"same").add(this.convBias(t))},e.prototype.conv=function(e,t,n){var r=this.weights("Conv2d_"+String(n));return e.conv2d(r,t,"same").add(this.convBias("Conv2d_"+String(n))).clipByValue(0,6)},e.prototype.separableConv=function(e,t,n,r){void 0===r&&(r=1);var i="Conv2d_"+String(n)+"_depthwise",o="Conv2d_"+String(n)+"_pointwise";return e.depthwiseConv2D(this.depthwiseWeights(i),t,"same","NHWC",r).add(this.depthwiseBias(i)).clipByValue(0,6).conv2d(this.weights(o),[1,1],"same").add(this.convBias(o)).clipByValue(0,6)},e.prototype.weights=function(e){return this.modelWeights.weights(e)},e.prototype.convBias=function(e){return this.modelWeights.convBias(e)},e.prototype.depthwiseBias=function(e){return this.modelWeights.depthwiseBias(e)},e.prototype.depthwiseWeights=function(e){return this.modelWeights.depthwiseWeights(e)},e.prototype.dispose=function(){this.modelWeights.dispose()},e}(),f=["nose","leftEye","rightEye","leftEar","rightEar","leftShoulder","rightShoulder","leftElbow","rightElbow","leftWrist","rightWrist","leftHip","rightHip","leftKnee","rightKnee","leftAnkle","rightAnkle"],p=f.length,h=f.reduce(function(e,t,n){return e[t]=n,e},{}),v=[["nose","leftEye"],["leftEye","leftEar"],["nose","rightEye"],["rightEye","rightEar"],["nose","leftShoulder"],["leftShoulder","leftElbow"],["leftElbow","leftWrist"],["leftShoulder","leftHip"],["leftHip","leftKnee"],["leftKnee","leftAnkle"],["nose","rightShoulder"],["rightShoulder","rightElbow"],["rightElbow","rightWrist"],["rightShoulder","rightHip"],["rightHip","rightKnee"],["rightKnee","rightAnkle"]],d=[["leftHip","leftShoulder"],["leftElbow","leftShoulder"],["leftElbow","leftWrist"],["leftHip","leftKnee"],["leftKnee","leftAnkle"],["rightHip","rightShoulder"],["rightElbow","rightShoulder"],["rightElbow","rightWrist"],["rightHip","rightKnee"],["rightKnee","rightAnkle"],["leftShoulder","rightShoulder"],["leftHip","rightHip"]].map(function(e){var t=e[0],n=e[1];return[h[t],h[n]]});var b=Number.NEGATIVE_INFINITY,m=Number.POSITIVE_INFINITY;function g(e){return e.reduce(function(e,t){var n=e.maxX,r=e.maxY,i=e.minX,o=e.minY,s=t.position,a=s.x,u=s.y;return{maxX:Math.max(n,a),maxY:Math.max(r,u),minX:Math.min(i,a),minY:Math.min(o,u)}},{maxX:b,maxY:b,minX:m,minY:m})}function y(e,i){return void 0===i&&(i="float32"),n(this,void 0,void 0,function(){var n;return r(this,function(r){switch(r.label){case 0:return[4,e.data()];case 1:return n=r.sent(),[2,t.buffer(e.shape,i,n)]}})})}function w(e,t,n){return{score:e.score,keypoints:e.keypoints.map(function(e){var r=e.score,i=e.part,o=e.position;return{score:r,part:i,position:{x:o.x*n,y:o.y*t}}})}}function _(e,t,n){var r=t*e-1;return r-r%n+1}function x(e){return e instanceof t.Tensor?[e.shape[0],e.shape[1]]:[e.height,e.width]}function C(e,n,r,i){return t.tidy(function(){var o=function(e){return e instanceof t.Tensor?e:t.browser.fromPixels(e)}(e);return i?o.reverse(1).resizeBilinear([n,r]):o.resizeBilinear([n,r])})}function k(e){return Math.floor(e/2)}var E=function(){function e(e,t){this.priorityQueue=new Array(e),this.numberOfElements=-1,this.getElementValue=t}return e.prototype.enqueue=function(e){this.priorityQueue[++this.numberOfElements]=e,this.swim(this.numberOfElements)},e.prototype.dequeue=function(){var e=this.priorityQueue[0];return this.exchange(0,this.numberOfElements--),this.sink(0),this.priorityQueue[this.numberOfElements+1]=null,e},e.prototype.empty=function(){return-1===this.numberOfElements},e.prototype.size=function(){return this.numberOfElements+1},e.prototype.all=function(){return this.priorityQueue.slice(0,this.numberOfElements+1)},e.prototype.max=function(){return this.priorityQueue[0]},e.prototype.swim=function(e){for(;e>0&&this.less(k(e),e);)this.exchange(e,k(e)),e=k(e)},e.prototype.sink=function(e){for(;2*e<=this.numberOfElements;){var t=2*e;if(t<this.numberOfElements&&this.less(t,t+1)&&t++,!this.less(e,t))break;this.exchange(e,t),e=t}},e.prototype.getValueAt=function(e){return this.getElementValue(this.priorityQueue[e])},e.prototype.less=function(e,t){return this.getValueAt(e)<this.getValueAt(t)},e.prototype.exchange=function(e,t){var n=this.priorityQueue[e];this.priorityQueue[e]=this.priorityQueue[t],this.priorityQueue[t]=n},e}();function S(e,t,n,r,i,o){for(var s=o.shape,a=s[0],u=s[1],l=!0,c=Math.max(n-i,0),f=Math.min(n+i+1,a),p=c;p<f;++p){for(var h=Math.max(r-i,0),v=Math.min(r+i+1,u),d=h;d<v;++d)if(o.get(p,d,e)>t){l=!1;break}if(!l)break}return l}function P(e,t,n,r){return{y:r.get(e,t,n),x:r.get(e,t,n+p)}}function M(e,t,n){var r=P(e.heatmapY,e.heatmapX,e.id,n),i=r.y,o=r.x;return{x:e.heatmapX*t+o,y:e.heatmapY*t+i}}function O(e,t,n){return e<t?t:e>n?n:e}function N(e,t){return{x:e.x+t.x,y:e.y+t.y}}var B=v.map(function(e){var t=e[0],n=e[1];return[h[t],h[n]]}),A=B.map(function(e){return e[1]}),V=B.map(function(e){return e[0]});function I(e,t,n,r){return{y:O(Math.round(e.y/t),0,n-1),x:O(Math.round(e.x/t),0,r-1)}}function T(e,t,n,r,i,o,s){var a=r.shape,u=a[0],l=a[1],c=function(e,t,n){var r=n.shape[2]/2;return{y:n.get(t.y,t.x,e),x:n.get(t.y,t.x,r+e)}}(e,I(t.position,o,u,l),s),p=I(N(t.position,c),o,u,l),h=P(p.y,p.x,n,i),v=r.get(p.y,p.x,n);return{position:N({x:p.x*o,y:p.y*o},{x:h.x,y:h.y}),part:f[n],score:v}}function W(e,t,n,r,i,o){var s=t.shape[2],a=A.length,u=new Array(s),l=e.part,c=e.score,p=M(l,r,n);u[l.id]={score:c,part:f[l.id],position:p};for(var h=a-1;h>=0;--h){var v=A[h],d=V[h];u[v]&&!u[d]&&(u[d]=T(h,u[v],d,t,n,r,o))}for(h=0;h<a;++h){v=V[h],d=A[h];u[v]&&!u[d]&&(u[d]=T(h,u[v],d,t,n,r,i))}return u}function F(e,t,n,r){var i=n.x,o=n.y;return e.some(function(e){var n,s,a,u,l,c,f=e.keypoints[r].position;return n=o,s=i,a=f.y,u=f.x,(l=a-n)*l+(c=u-s)*c<=t})}function j(e,t,n){return n.reduce(function(n,r,i){var o=r.position,s=r.score;return F(e,t,o,i)||(n+=s),n},0)/n.length}var H=1;function Y(e,t,i,o,s,a,u,l){return void 0===u&&(u=.5),void 0===l&&(l=20),n(this,void 0,void 0,function(){var c,f,p,h,v,d,b,m,g,w,_,x;return r(this,function(C){switch(C.label){case 0:return c=[],[4,function(e){return n(this,void 0,void 0,function(){return r(this,function(t){return[2,Promise.all(e.map(function(e){return y(e,"float32")}))]})})}([e,t,i,o])];case 1:for(f=C.sent(),p=f[0],h=f[1],v=f[2],d=f[3],b=function(e,t,n){for(var r=n.shape,i=r[0],o=r[1],s=r[2],a=new E(i*o*s,function(e){return e.score}),u=0;u<i;++u)for(var l=0;l<o;++l)for(var c=0;c<s;++c){var f=n.get(u,l,c);f<e||S(c,f,u,l,t,n)&&a.enqueue({score:f,part:{heatmapY:u,heatmapX:l,id:c}})}return a}(u,H,p),m=l*l;c.length<a&&!b.empty();)g=b.dequeue(),w=M(g.part,s,h),F(c,m,w,g.part.id)||(_=W(g,p,h,s,v,d),x=j(c,m,_),c.push({keypoints:_,score:x}));return[2,c]}})})}function K(e){var n=e.shape,r=n[0],i=n[1],o=n[2];return t.tidy(function(){var n,s,a=e.reshape([r*i,o]).argMax(0),u=a.div(t.scalar(i,"int32")).expandDims(1),l=(n=a,s=i,t.tidy(function(){var e=n.div(t.scalar(s,"int32"));return n.sub(e.mul(t.scalar(s,"int32")))})).expandDims(1);return t.concat([u,l],1)})}function Q(e,t,n,r){return{y:r.get(e,t,n),x:r.get(e,t,n+p)}}function X(e,n,r){return t.tidy(function(){var i=function(e,n){for(var r=[],i=0;i<p;i++){var o=Q(e.get(i,0).valueOf(),e.get(i,1).valueOf(),i,n),s=o.x,a=o.y;r.push(a),r.push(s)}return t.tensor2d(r,[p,2])}(e,r);return e.toTensor().mul(t.scalar(n,"int32")).toFloat().add(i)})}function D(e,t,i){return n(this,void 0,void 0,function(){var n,o,s,a,u,l,c,p,h,v;return r(this,function(r){switch(r.label){case 0:return n=0,o=K(e),[4,Promise.all([y(e),y(t),y(o,"int32")])];case 1:return s=r.sent(),a=s[0],u=s[1],l=s[2],[4,y(c=X(l,i,u))];case 2:return p=r.sent(),h=Array.from(function(e,t){for(var n=t.shape[0],r=new Float32Array(n),i=0;i<n;i++){var o=t.get(i,0),s=t.get(i,1);r[i]=e.get(o,s,i)}return r}(a,l)),v=h.map(function(e,t){return n+=e,{position:{y:p.get(t,0),x:p.get(t,1)},part:f[t],score:e}}),o.dispose(),c.dispose(),[2,{keypoints:v,score:n/v.length}]}})})}var R="https://storage.googleapis.com/tfjs-models/weights/posenet/",q={1.01:{url:R+"mobilenet_v1_101/",architecture:l[100]},1:{url:R+"mobilenet_v1_100/",architecture:l[100]},.75:{url:R+"mobilenet_v1_075/",architecture:l[75]},.5:{url:R+"mobilenet_v1_050/",architecture:l[50]}},z=function(){function e(e){this.variables=e}return e.prototype.weights=function(e){return this.variables["MobilenetV1/"+e+"/weights"]},e.prototype.depthwiseBias=function(e){return this.variables["MobilenetV1/"+e+"/biases"]},e.prototype.convBias=function(e){return this.depthwiseBias(e)},e.prototype.depthwiseWeights=function(e){return this.variables["MobilenetV1/"+e+"/depthwise_weights"]},e.prototype.dispose=function(){for(var e in this.variables)this.variables[e].dispose()},e}(),G=function(){function e(e){this.mobileNet=e}return e.prototype.predictForSinglePose=function(e,n){var r=this;return void 0===n&&(n=16),a(n),t.tidy(function(){var t=r.mobileNet.predict(e,n),i=r.mobileNet.convToOutput(t,"heatmap_2"),o=r.mobileNet.convToOutput(t,"offset_2");return{heatmapScores:i.sigmoid(),offsets:o}})},e.prototype.predictForMultiPose=function(e,n){var r=this;return void 0===n&&(n=16),t.tidy(function(){var t=r.mobileNet.predict(e,n),i=r.mobileNet.convToOutput(t,"heatmap_2"),o=r.mobileNet.convToOutput(t,"offset_2"),s=r.mobileNet.convToOutput(t,"displacement_fwd_2"),a=r.mobileNet.convToOutput(t,"displacement_bwd_2");return{heatmapScores:i.sigmoid(),offsets:o,displacementFwd:s,displacementBwd:a}})},e.prototype.estimateSinglePose=function(e,i,o,s){return void 0===i&&(i=.5),void 0===o&&(o=!1),void 0===s&&(s=16),n(this,void 0,void 0,function(){var n,l,c,f,p,h,v,d,b,m,g,y=this;return r(this,function(r){switch(r.label){case 0:return a(s),u(i),n=x(e),l=n[0],c=n[1],f=_(i,l,s),p=_(i,c,s),h=t.tidy(function(){var t=C(e,f,p,o);return y.predictForSinglePose(t,s)}),v=h.heatmapScores,d=h.offsets,[4,D(v,d,s)];case 1:return b=r.sent(),m=l/f,g=c/p,v.dispose(),d.dispose(),[2,w(b,m,g)]}})})},e.prototype.estimateMultiplePoses=function(e,i,o,s,l,c,f){return void 0===i&&(i=.5),void 0===o&&(o=!1),void 0===s&&(s=16),void 0===l&&(l=5),void 0===c&&(c=.5),void 0===f&&(f=20),n(this,void 0,void 0,function(){var n,p,h,v,d,b,m,g,y,k,E,S=this;return r(this,function(r){switch(r.label){case 0:return a(s),u(i),n=x(e),p=n[0],h=n[1],v=_(i,p,s),d=_(i,h,s),b=t.tidy(function(){var t=C(e,v,d,o);return S.predictForMultiPose(t,s)}),m=b.heatmapScores,g=b.offsets,y=b.displacementFwd,k=b.displacementBwd,[4,Y(m,g,y,k,s,l,c,f)];case 1:return E=r.sent(),m.dispose(),g.dispose(),y.dispose(),k.dispose(),[2,function(e,t,n){return 1===n&&1===t?e:e.map(function(e){return w(e,t,n)})}(E,p/v,h/d)]}})})},e.prototype.dispose=function(){this.mobileNet.dispose()},e}();var L={load:function(e){return n(void 0,void 0,void 0,function(){var t,n,o;return r(this,function(r){switch(r.label){case 0:return t=q[e],[4,new i(t.url).getAllVariables()];case 1:return n=r.sent(),o=new z(n),[2,new c(o,t.architecture)]}})})}};e.decodeMultiplePoses=Y,e.decodeSinglePose=D,e.MobileNet=c,e.mobileNetArchitectures=l,e.CheckpointLoader=i,e.checkpoints=q,e.partChannels=["left_face","right_face","right_upper_leg_front","right_lower_leg_back","right_upper_leg_back","left_lower_leg_front","left_upper_leg_front","left_upper_leg_back","left_lower_leg_back","right_feet","right_lower_leg_front","left_feet","torso_front","torso_back","right_upper_arm_front","right_upper_arm_back","right_lower_arm_back","left_lower_arm_front","left_upper_arm_front","left_upper_arm_back","left_lower_arm_back","right_hand","right_lower_arm_front","left_hand"],e.partIds=h,e.partNames=f,e.poseChain=v,e.load=function(e){return void 0===e&&(e=1.01),n(this,void 0,void 0,function(){var n,i;return r(this,function(r){switch(r.label){case 0:if(null==t)throw new Error("Cannot find TensorFlow.js. If you are using a <script> tag, please also include @tensorflow/tfjs on the page before using this model.");return n=Object.keys(q),t.util.assert("number"==typeof e,function(){return"got multiplier type of "+typeof e+" when it should be a number."}),t.util.assert(n.indexOf(e.toString())>=0,function(){return"invalid multiplier value of "+e+".  No checkpoint exists for that multiplier. Must be one of "+n.join(",")+"."}),[4,L.load(e)];case 1:return i=r.sent(),[2,new G(i)]}})})},e.PoseNet=G,e.getAdjacentKeyPoints=function(e,t){return d.reduce(function(n,r){var i=r[0],o=r[1];return function(e,t,n){return e<n||t<n}(e[i].score,e[o].score,t)?n:(n.push([e[i],e[o]]),n)},[])},e.getBoundingBox=g,e.getBoundingBoxPoints=function(e){var t=g(e),n=t.minX,r=t.minY,i=t.maxX,o=t.maxY;return[{x:n,y:r},{x:i,y:r},{x:i,y:o},{x:n,y:o}]},e.scalePose=w,Object.defineProperty(e,"__esModule",{value:!0})});
