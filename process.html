<html>
  <head>
    <title>Process</title>
    <script src="https://unpkg.com/@tensorflow/tfjs"></script>
    <script src="https://unpkg.com/@tensorflow-models/posenet"></script>
    <script>

      function sendReceive(data, id){
        var xhr = new XMLHttpRequest();
        var url = "//localhost:5678/sendReceive";
        xhr.open("POST", url, true);
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                
                var json = JSON.parse(xhr.responseText);
                
                if ("image" in json) {
                  console.log(json.image);
                  compute(json.image, json.id);
                } else {
                  console.log("Looks like we are done here!");
                }

            }else{
              console.log('SHIT');
            }
        };
        xhr.send(JSON.stringify({data, id}));
      }

      const multiplier = 0.5;
      const imageScaleFactor = 0.5;
      const flipHorizontal = false;
      const outputStride = 8;
      let estimator = null;
      let net;
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
    
      async function compute(src, id) {
        const imageElement = new Image();
        const src_parts = src.split("europeana_downloads_complete/");
        imageElement.src = "http://127.0.0.1:9000/" + src_parts[src_parts.length-1];
        imageElement.crossOrigin = "Anonymous"
        imageElement.onload = () => {
          
          const input = tf.browser.fromPixels(imageElement);

          canvas.width = imageElement.width;
          canvas.height = imageElement.height;
          ctx.clearRect(0,0,canvas.width, canvas.height);
          ctx.drawImage(imageElement, 0, 0, canvas.width, canvas.height)
          let imgdata = ctx.getImageData(0, 0, canvas.width, canvas.height);
          
          const resp = await estimator(imgdata, imageScaleFactor, flipHorizontal, outputStride);

          window.requestAnimationFrame(function(){ sendReceive(resp, id);});
        }
      }

      function createEstimator(net) {
        return function (imageElement, scaleFactor, flipHorizontal, outputStride) {
          return net.estimateMultiplePoses(imageElement, scaleFactor, flipHorizontal, outputStride);
        }
      }

      function start() {
        posenet
          .load(multiplier)
          .then(function (pnet) {
            net = pnet;
            estimator = createEstimator(net);
            sendReceive([], 0);
          });
      }

    </script>
  </head>
  <body>
  </body>
</html>